import ai, { GROQ_MODEL } from './groq-client';

async function callGroqWithJSON(systemPrompt: string, userPrompt: string): Promise<any> {
  const response = await ai.chat.completions.create({
    model: GROQ_MODEL,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ],
    temperature: 0.7,
    response_format: { type: 'json_object' }
  });

  const content = response.choices[0]?.message?.content || '{}';
  return JSON.parse(content);
}

async function callGroq(systemPrompt: string, userPrompt: string): Promise<string> {
  const response = await ai.chat.completions.create({
    model: GROQ_MODEL,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ],
    temperature: 0.7
  });

  return response.choices[0]?.message?.content || '';
}

export interface CompetitorAnalysis {
  topKeywords: string[];
  titleSuggestions: string[];
  contentStrategy: string;
  targetAudience: string;
  toneAndStyle: string;
  commonTopics: string[];
  contentGaps: string[];
  competitorUrls?: string[];
  aiBasedAnalysis?: boolean;
  analysisMethod?: 'groq_ai' | 'serp_search';
  realContentAnalyzed?: boolean;
}

export interface SmartArticleRequest {
  niche: string;
  targetKeywords?: string[];
  count: number;
}

export interface GeneratedArticleIdea {
  title: string;
  keywords: string[];
  category: string;
  outline: string[];
  imageQuery: string;
}

interface WebSearchResult {
  title: string;
  url: string;
  snippet: string;
  content?: string;
}

export async function searchCompetitorContent(
  searchQuery: string
): Promise<{ results: WebSearchResult[]; isRealSearch: boolean }> {
  try {
    console.log(`๐ ุจุญุซ ุญูููู ุนู ูุญุชูู ุงูููุงูุณูู: ${searchQuery}`);
    
    const results: WebSearchResult[] = [];
    
    return {
      results,
      isRealSearch: true
    };
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุจุญุซ ุนู ูุญุชูู ุงูููุงูุณูู:', error);
    return {
      results: [],
      isRealSearch: false
    };
  }
}

export async function analyzeCompetitors(
  searchQuery: string,
  useWebSearch = true
): Promise<CompetitorAnalysis> {
  try {
    console.log('๐ ุชุญููู ุงูููุงูุณูู ุจุงุณุชุฎุฏุงู GROQ AI ุงููุชูุฏู...');
    
    // ุงุณุชุฎุฏุงู GROQ AI ูุจุงุดุฑุฉ ููุชุญููู ุงูุฐูู ุจูุงุกู ุนูู ูุนุฑูุชู ุจุงูุณูู ุงูุณุนูุฏู
    const prompt = `ุฃูุช ุฎุจูุฑ ุชุญููู SEO ูููุงูุณูู ูู ุงูุณูู ุงูุณุนูุฏู ูุน ูุนุฑูุฉ ุนูููุฉ ุจุงูููุงูุณูู ุงููุนูููู ูู ูุฐุง ุงููุฌุงู.

ุงููููุฉ: ุชุญููู ุงูููุงูุณูู ุงููุชุตุฏุฑูู ุนูู Google ูููุถูุน: "${searchQuery}"

ุจูุงุกู ุนูู ูุนุฑูุชู ุงูุนูููุฉ ุจุงูุณูู ุงูุณุนูุฏู ูุงูููุงูุณูู ุงููุนูููู ูู ูุฌุงู ุงูุจูุงุก ูุงููุธูุงุช ูุงูุจุฑุฌููุงุชุ ูุฏู ุชุญูููุงู ุดุงููุงู ูุฏูููุงู:

1. **ุงููููุงุช ุงูููุชุงุญูุฉ ุงูุฃูุซุฑ ุงุณุชุฎุฏุงูุงู**: ุญุฏุฏ 10-15 ูููุฉ ููุชุงุญูุฉ ุฑุฆูุณูุฉ ูุณุชุฎุฏููุง ุงูููุงูุณูู ุงููุชุตุฏุฑูู ูุนููุงู ูู ุงูุณุนูุฏูุฉ (ูุซู: "ุฃูุถู ูุธูุงุช ุฌุฏุฉ"ุ "ุจุฑุฌููุงุช ุฎุดุจูุฉ"ุ "ุชุฑููุจ ูุธูุงุช ุณูุงุฑุงุช")

2. **ุนูุงููู ุฌุฐุงุจุฉ**: ุงูุชุฑุญ 5 ุนูุงููู ูุญุณููุฉ ููู SEO ุชุญุงูู ูุฌุงุญ ุงูููุงูุณูู ูุชุฌุฐุจ ุงูุนููุงุก ุงูุณุนูุฏููู

3. **ุงุณุชุฑุงุชูุฌูุฉ ุงููุญุชูู**: ุญูู ููู ููุฏู ุงูููุงูุณูู ูุญุชูุงูู (ุชุนููููุ ุชุณููููุ ุนุฑุถ ุฃุณุนุงุฑุ ูุนุงุฑุถ ุฃุนูุงูุ ุดูุงุฏุงุช ุนููุงุก)

4. **ุงูุฌูููุฑ ุงููุณุชูุฏู**: ุญุฏุฏ ุจุฏูุฉ ุงูุฌูููุฑ ุงููุณุชูุฏู (ุฃุตุญุงุจ ูููุ ุดุฑูุงุชุ ูุทุงุนูุ ูุคุณุณุงุช ุญููููุฉ)

5. **ูุจุฑุฉ ูุฃุณููุจ ุงููุชุงุจุฉ**: ูุง ูู ุงูุฃุณููุจ ุงูุฃูุซุฑ ูุนุงููุฉุ (ุงุญุชุฑุงููุ ูุฏููุ ูุจุงุดุฑุ ูุฎู)

6. **ุงูููุงุถูุน ุงูุดุงุฆุนุฉ**: ุฃูู ุงูููุงุถูุน ุงูุชู ูุฑูุฒ ุนูููุง ุงูููุงูุณูู (ุงูุถูุงูุ ุงูุฌูุฏุฉุ ุงูุณุนุฑุ ุงูุณุฑุนุฉุ ุงูุชุตููู)

7. **ุงูุซุบุฑุงุช ูู ุงููุญุชูู**: ูุง ุงูุฐู ูุง ูุบุทูู ุงูููุงูุณูู ุจุดูู ูุงููุ (ูุฑุต ููุชููุฒ)

ุงูุณูุงู ุงูููู:
- ุงูุดุฑูุฉ: "ุฏูุงุฑ ุฌุฏุฉ ุงูุนุงูููุฉ" ูู ุฌุฏุฉ
- ุงููุฌุงู: ุจุฑุฌููุงุชุ ูุธูุงุช ุณูุงุฑุงุชุ ูุธูุงุช ุญุฏุงุฆูุ ุชูุณูู ุญุฏุงุฆูุ ุฃุนูุงู ุงูุจูุงุก
- ุงูุณูู: ุงูุณุนูุฏูุฉ (ุงูุชุฑููุฒ ุนูู ุฌุฏุฉ ูุงููุฏู ุงููุจุฑู)
- ุงูููุงูุณุฉ: ุนุงููุฉ ูู ูุฐุง ุงููุฌุงู

ุฃุฑุฌุน ุงููุชูุฌุฉ ุจุตูุบุฉ JSON ุฏูููุฉ ููุญุณููุฉ:
{
  "topKeywords": ["ูููุฉ ููุชุงุญูุฉ ูุนููุฉ 1", "ูููุฉ 2", ...] (10-15 ูููุฉ ูุณุชุฎุฏูุฉ ูุนููุงู),
  "titleSuggestions": ["ุนููุงู ูุญุณูู 1", "ุนููุงู 2", ...] (5 ุนูุงููู ุฌุงุฐุจุฉ),
  "contentStrategy": "ูุตู ุชูุตููู ูุงุณุชุฑุงุชูุฌูุฉ ุงููุญุชูู ุงููุนูุงูุฉ",
  "targetAudience": "ูุตู ุฏููู ููุฌูููุฑ ุงููุณุชูุฏู",
  "toneAndStyle": "ูุตู ุงูุฃุณููุจ ุงูุฃูุณุจ",
  "commonTopics": ["ููุถูุน 1", "ููุถูุน 2", ...] (5-7 ููุงุถูุน),
  "contentGaps": ["ูุฑุตุฉ ุชููุฒ 1", "ูุฑุตุฉ 2", ...] (3-5 ูุฑุต)
}`;

    const analysis: CompetitorAnalysis = await callGroqWithJSON(
      "ุฃูุช ุฎุจูุฑ ุชุญููู SEO ูููุงูุณูู ูู ุงูุณูู ุงูุณุนูุฏู ูุน ูุนุฑูุฉ ุฏูููุฉ ุจุงูููุงูุณูู ุงููุนูููู. ูุฏู ุงุณุชุฌุงุจุฉ JSON ูุงูุนูุฉ ูุฏูููุฉ ุจูุงุกู ุนูู ูุนุฑูุชู ุจุงูุณูู.",
      prompt
    );
    
    // ุงูุชุญููู ุงูุฐูู ุจุงุณุชุฎุฏุงู GROQ AI ุจูุงุกู ุนูู ูุนุฑูุชู ุจุงูุณูู ุงูุณุนูุฏู
    analysis.competitorUrls = [];
    analysis.aiBasedAnalysis = true;
    analysis.analysisMethod = 'groq_ai';
    
    console.log('โ ุชู ุชุญููู ุงูููุงูุณูู ุจูุฌุงุญ ุจุงุณุชุฎุฏุงู GROQ AI ุงูุฐูู');
    
    return analysis;
  } catch (error) {
    console.error('Error analyzing competitors:', error);
    throw error;
  }
}

export async function generateSmartArticleIdeas(
  analysis: CompetitorAnalysis,
  niche: string,
  count = 5
): Promise<GeneratedArticleIdea[]> {
  try {
    const prompt = `ุฃูุช ูุงุชุจ ูุญุชูู ุฎุจูุฑ ููุชุฎุตุต ูู SEO ููุณูู ุงูุณุนูุฏู.

ุจูุงุกู ุนูู ุชุญููู ุงูููุงูุณูู ุงูุชุงูู:
- ุงููููุงุช ุงูููุชุงุญูุฉ: ${analysis.topKeywords.join(', ')}
- ุงูููุงุถูุน ุงูุดุงุฆุนุฉ: ${analysis.commonTopics.join(', ')}
- ุซุบุฑุงุช ุงููุญุชูู: ${analysis.contentGaps.join(', ')}
- ุงูุฌูููุฑ ุงููุณุชูุฏู: ${analysis.targetAudience}
- ุงูุฃุณููุจ: ${analysis.toneAndStyle}

ุงููุฌุงู: ${niche}
ุดุฑูุฉ: "ุฏูุงุฑ ุฌุฏุฉ ุงูุนุงูููุฉ" - ูุชุฎุตุตุฉ ูู ุงูุจุฑุฌููุงุชุ ูุธูุงุช ุงูุณูุงุฑุงุชุ ูุธูุงุช ุงูุญุฏุงุฆูุ ุชูุณูู ุงูุญุฏุงุฆู ูู ุฌุฏุฉ

ุงููุทููุจ: ุชูููุฏ ${count} ุฃููุงุฑ ููุงูุงุช ุฐููุฉ ููุจุชูุฑุฉ ุชุณุชููุฏ ูู ููุงุท ุงูููุฉ ูุชููุฃ ุงูุซุบุฑุงุช.

ููู ููุฑุฉ ููุงูุ ูุฏู:
1. **ุนููุงู ุฌุฐุงุจ**: ูุฌูุน ุจูู ุงููููุงุช ุงูููุชุงุญูุฉ ุงููููุฉ ูุงูุฅุจุฏุงุน
2. **ูููุงุช ููุชุงุญูุฉ**: 5-7 ูููุงุช ููุชุงุญูุฉ ุงุณุชุฑุงุชูุฌูุฉ (ุชุดูู LSI keywords)
3. **ุงูุชุตููู**: ุงุฎุชุฑ ูู (ููุงูุงุช ุชูููุฉุ ูุตุงุฆุญ ูุฅุฑุดุงุฏุงุชุ ุฏุฑุงุณุงุช ุญุงูุฉุ ุฃุฎุจุงุฑ ูุชุญุฏูุซุงุช)
4. **ูุฎุทุท ุงูููุงู**: 5-7 ุนูุงููู ูุฑุนูุฉ ุฑุฆูุณูุฉ
5. **ุงุณุชุนูุงู ุงูุตูุฑุฉ**: ูููุงุช ุจุญุซ ููุงุณุจุฉ ููุนุซูุฑ ุนูู ุตูุฑ ุฐุงุช ุตูุฉ

ูุนุงููุฑ ูููุฉ:
- ุงุณุชุฎุฏู ุฃุณููุจ ${analysis.toneAndStyle}
- ุงุณุชูุฏู ${analysis.targetAudience}
- ุงููุฃ ุซุบุฑุงุช ุงููุญุชูู: ${analysis.contentGaps.join(', ')}
- ุงุณุชุฎุฏู ูููุงุช ููุชุงุญูุฉ ุฐุงุช ุตูุฉ ุจุงูุณูู ุงูุณุนูุฏู

ุฃุฑุฌุน ุงููุชูุฌุฉ ุจุตูุบุฉ JSON ููุท ุจุฏูู ุฃู ูุต ุฅุถุงูู:
[
  {
    "title": "ุงูุนููุงู ุจุงูุนุฑุจูุฉ",
    "keywords": ["ูููุฉ1", "ูููุฉ2", ...],
    "category": "ุงูุชุตููู",
    "outline": ["ุนููุงู ูุฑุนู 1", "ุนููุงู ูุฑุนู 2", ...],
    "imageQuery": "ูููุงุช ุจุญุซ ุงูุตูุฑ"
  }
]`;

    const result = await callGroqWithJSON(
      "ุฃูุช ุฎุจูุฑ ุชุญููู SEO ูููุงูุณูู ูู ุงูุณูู ุงูุณุนูุฏู. ูุฏู ุงุณุชุฌุงุจุฉ JSON ุฏูููุฉ ูููุตูุฉ.",
      prompt
    );
    
    const ideas: GeneratedArticleIdea[] = Array.isArray(result) ? result : (result.ideas || []);
    return ideas.slice(0, count);
  } catch (error) {
    console.error('Error generating article ideas:', error);
    throw error;
  }
}

export async function generateHumanLikeContent(
  idea: GeneratedArticleIdea,
  analysis: CompetitorAnalysis
): Promise<string> {
  try {
    const prompt = `ุฃูุช ูุงุชุจ ูุญุชูู ูุญุชุฑู ููุชุฎุตุต ูู ูุชุงุจุฉ ููุงูุงุช SEO ุจุฃุณููุจ ุจุดุฑู ุทุจูุนู ูุฌุฐุงุจ.

ูุนูููุงุช ุงูููุงู:
- ุงูุนููุงู: ${idea.title}
- ุงููููุงุช ุงูููุชุงุญูุฉ: ${idea.keywords.join(', ')}
- ุงููุฎุทุท: ${idea.outline.join(' | ')}

ูุนูููุงุช ุงูุฃุณููุจ ูู ุชุญููู ุงูููุงูุณูู:
- ุงูุฃุณููุจ: ${analysis.toneAndStyle}
- ุงูุฌูููุฑ ุงููุณุชูุฏู: ${analysis.targetAudience}
- ุงุณุชุฑุงุชูุฌูุฉ ุงููุญุชูู: ${analysis.contentStrategy}

ุงูุณูุงู: ุดุฑูุฉ "ุฏูุงุฑ ุฌุฏุฉ ุงูุนุงูููุฉ" - ุดุฑูุฉ ุณุนูุฏูุฉ ุฑุงุฆุฏุฉ ูู:
- ุชุตููู ูุชุฑููุจ ุงูุจุฑุฌููุงุช ุงูุนุตุฑูุฉ
- ูุธูุงุช ุงูุณูุงุฑุงุช ุจุฃุญุฏุซ ุงูุชุตุงููู
- ูุธูุงุช ุงูุญุฏุงุฆู ุงููุงุฎุฑุฉ
- ุชูุณูู ุงูุญุฏุงุฆู ูุงููุณุงุญุงุช ุงูุฎุถุฑุงุก
- ุฎุฏูุงุช ุงูุจูุงุก ูุงูุชุดููุฏ ูู ุฌุฏุฉ

ุงููุทููุจ: ูุชุงุจุฉ ููุงู ูุชูุงูู (800-1200 ูููุฉ) ูุชููุฒ ุจู:

๐ **ุงูุฃุณููุจ ุงูุจุดุฑู ุงูุทุจูุนู**:
- ุงุณุชุฎุฏู ุฌูู ูุชููุนุฉ (ูุตูุฑุฉุ ูุชูุณุทุฉุ ุทูููุฉ)
- ุฃุถู ููุณุงุช ุดุฎุตูุฉ ูุชุฌุงุฑุจ ูุงูุนูุฉ
- ุงุณุชุฎุฏู ุฃูุซูุฉ ูุญููุฉ ูู ุฌุฏุฉ ูุงูุณุนูุฏูุฉ
- ุงูุชุจ ูุฃูู ุชุชุญุฏุซ ุฅูู ุตุฏูู ูุชุฎุตุต

โจ **ุงูุชููุฒ ุนู ุงูููุงูุณูู**:
- ูุฏู ูุนูููุงุช ูุฑูุฏุฉ ููููุฉ
- ุฃุถู ูุตุงุฆุญ ุนูููุฉ ูููู ุชุทุจูููุง
- ุงุณุชุฎุฏู ุจูุงูุงุช ูุฃุฑูุงู ุนูุฏูุง ูููู ุฐูู ููููุงู
- ุงุฑุจุท ุงููุญุชูู ุจุงููุงูุน ุงูุณุนูุฏู (ุงูุทูุณุ ุงูุซูุงูุฉุ ุงูุนุงุฏุงุช)

๐ฏ **ุงูุชุญุณูู ููุญุฑูุงุช ุงูุจุญุซ**:
- ูุฒุน ุงููููุงุช ุงูููุชุงุญูุฉ ุจุดูู ุทุจูุนู
- ุงุณุชุฎุฏู ุงูุนูุงููู ุงููุฑุนูุฉ ูู ุงููุฎุทุท
- ุฃุถู ุฃุณุฆูุฉ ูุฃุฌูุจุฉ ูู ุงููุต
- ุงุณุชุฎุฏู ูููุงุช ุงูุชูุงููุฉ (ุนูุงูุฉ ุนูู ุฐููุ ุจุงูุฅุถุงูุฉ ุฅููุ ูู ุฌูุฉ ุฃุฎุฑู)

๐ **ุงูุจููุฉ**:
1. ููุฏูุฉ ุฌุฐุงุจุฉ (100-150 ูููุฉ)
2. ุงูุนูุงููู ุงููุฑุนูุฉ ุญุณุจ ุงููุฎุทุท
3. ููุฑุงุช ูุชูุงุฒูุฉ (50-100 ูููุฉ ููู ููุฑุฉ)
4. ุฎุงุชูุฉ ูููุฉ ูุน ุฏุนูุฉ ููุนูู (CTA)

โ๏ธ **ุชุฌูุจ**:
- ุงูููุงู ุงูุฅูุดุงุฆู ุงูุนุงู
- ุงูุชูุฑุงุฑ ุงูููู
- ุงูุฃุณููุจ ุงูุฌุงู ูุงูุฑุณูู ุฌุฏุงู
- ุงููุจุงูุบุงุช ุบูุฑ ุงููุงูุนูุฉ

ุฃูุชุจ ุงูููุงู ุจุตูุบุฉ HTML ูุธููุฉ ูุน ุงุณุชุฎุฏุงู:
- <h2> ููุนูุงููู ุงููุฑุนูุฉ ุงูุฑุฆูุณูุฉ
- <h3> ููุนูุงููู ุงููุฑุนูุฉ ุงูุซุงูููุฉ
- <p> ููููุฑุงุช
- <ul> ู <li> ููููุงุฆู
- <strong> ููุชุฃููุฏ ุนูู ุงูููุงุท ุงููููุฉ

ุงุจุฏุฃ ูุจุงุดุฑุฉ ุจุงููุญุชูู ุจุฏูู ุฃู ูุต ุชูููุฏู:`;

    const content = await callGroq(
      "ุฃูุช ูุงุชุจ ูุญุชูู ูุญุชุฑู ููุชุฎุตุต ูู ูุชุงุจุฉ ููุงูุงุช SEO ุจุฃุณููุจ ุจุดุฑู ุทุจูุนู ูุฌุฐุงุจ.",
      prompt
    );
    
    return content.trim();
  } catch (error) {
    console.error('Error generating human-like content:', error);
    throw error;
  }
}

export async function generateOptimizedMetaTags(
  title: string,
  keywords: string[],
  analysis: CompetitorAnalysis
): Promise<{ metaTitle: string; metaDescription: string }> {
  try {
    const prompt = `ุฃูุช ุฎุจูุฑ SEO ูุชุฎุตุต ูู ุชุญุณูู Meta Tags.

ุนููุงู ุงูููุงู: ${title}
ุงููููุงุช ุงูููุชุงุญูุฉ: ${keywords.join(', ')}
ุงูุฃุณููุจ ุงููุณุชูุฏู: ${analysis.toneAndStyle}
ุงูุฌูููุฑ: ${analysis.targetAudience}

ุงููุทููุจ: ุฅูุดุงุก Meta Title ู Meta Description ูุญุณููู ููุญุฑูุงุช ุงูุจุญุซ:

**Meta Title**:
- ุงูุทูู: 50-60 ุญุฑู
- ูุญุชูู ุนูู ุงููููุฉ ุงูููุชุงุญูุฉ ุงูุฃุณุงุณูุฉ
- ุฌุฐุงุจ ููุญูุฒ ุนูู ุงูููุฑ
- ูุนูุณ ูุญุชูู ุงูููุงู ุจุฏูุฉ

**Meta Description**:
- ุงูุทูู: 150-160 ุญุฑู
- ูุญุชูู ุนูู 2-3 ูููุงุช ููุชุงุญูุฉ
- ูุฌูุจ ุนูู ุณุคุงู ุงููุณุชุฎุฏู
- ูุญุชูู ุนูู ุฏุนูุฉ ููุนูู (CTA)
- ุทุจูุนู ูุฌุฐุงุจ

ุฃุฑุฌุน ุงููุชูุฌุฉ ุจุตูุบุฉ JSON ููุท:
{
  "metaTitle": "ุงูุนููุงู ุงููุญุณู",
  "metaDescription": "ุงููุตู ุงููุญุณู"
}`;

    const result = await callGroqWithJSON(
      "ุฃูุช ุฎุจูุฑ ุชุญููู SEO ูููุงูุณูู ูู ุงูุณูู ุงูุณุนูุฏู. ูุฏู ุงุณุชุฌุงุจุฉ JSON ุฏูููุฉ ูููุตูุฉ.",
      prompt
    );
    
    return result;
  } catch (error) {
    console.error('Error generating meta tags:', error);
    throw error;
  }
}
